<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OD | Senior Jacket Couture</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Original Fonts + Academy Font + Arabic Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500&family=Bebas+Neue&family=Oswald:wght@400;500;600;700&family=Anton&family=Archivo+Black&family=Black+Ops+One&family=Russo+One&family=Orbitron:wght@400;500;600;700&family=Audiowide&family=Permanent+Marker&family=Rock+Salt&family=Press+Start+2P&family=Monoton&family=Iceberg&family=Plaster&family=Stardos+Stencil:wght@400;700&family=Abril+Fatface&family=Playfair+Display:wght@400;700&family=Pacifico&family=Dancing+Script:wght@400;700&family=Great+Vibes&family=Allura&family=Mr+De+Haviland&family=Brush+Script+MT&family=Lucida+Handwriting&family=Franklin+Gothic+Heavy&family=Cooper+Black&family=Impact&family=Arial+Black&family=Rockwell&family=Amiri:wght@400;700&family=Lateef:wght@400;700&family=Scheherazade+New:wght@400;700&family=Noto+Naskh+Arabic:wght@400;500;600;700&family=Noto+Sans+Arabic:wght@300;400;500;600;700&family=El+Messiri:wght@400;500;600;700&family=Reem+Kufi:wght@400;500;600;700&family=Markazi+Text:wght@400;500;600;700&family=Almarai:wght@300;400;700;800&family=Tajawal:wght@300;400;500;700;800&family=Changa:wght@300;400;500;600;700;800&family=Jomhuria&family=Rakkas&family=Mada:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/interactjs@1.10.17/dist/interact.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        :root {
            --od-cream: #f8f5f0;
            --od-offwhite: #fefdf9;
            --od-beige: #e8e2d9;
            --od-taupe: #d4ccc3;
            --od-charcoal: #3a3a3a;
            --od-dark: #2a2a2a;
            --od-gold: #c4a747;
            --od-gold-light: #d6c07c;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--od-cream);
            color: var(--od-charcoal);
            touch-action: manipulation;
        }
        
        .od-bg-cream {
            background-color: var(--od-cream);
        }
        
        .od-bg-offwhite {
            background-color: var(--od-offwhite);
        }
        
        .od-bg-beige {
            background-color: var(--od-beige);
        }
        
        .od-border {
            border-color: var(--od-taupe);
        }
        
        .od-text-dark {
            color: var(--od-charcoal);
        }
        
        .od-text-light {
            color: var(--od-taupe);
        }
        
        .od-accent {
            color: var(--od-gold);
        }
        
        .od-bg-accent {
            background-color: var(--od-gold);
        }
        
        .od-border-accent {
            border-color: var(--od-gold);
        }
        
        .hero {
            position: relative;
            overflow: hidden;
            padding: 60px 0;
            background: linear-gradient(135deg, var(--od-offwhite) 0%, var(--od-beige) 100%);
            border-bottom: 1px solid var(--od-taupe);
        }
        
        .logo {
            font-family: 'Bebas Neue', cursive;
            font-weight: 600;
            letter-spacing: 1px;
        }
        
        .jacket-container {
            position: relative;
            width: 100%;
            max-width: 800px;
            height: 400px;
            margin: 0 auto;
            background: var(--od-offwhite);
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.05);
            overflow: hidden;
            border: 1px solid var(--od-taupe);
        }
        
        .jacket-section {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            opacity: 0;
            transition: opacity 0.3s ease;
            padding: 15px;
        }
        
        .jacket-section.active {
            opacity: 1;
            z-index: 5;
        }
        
        .patch {
            position: absolute;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            cursor: move;
            display: none;
            transition: transform 0.2s ease;
            touch-action: none;
            background-color: transparent;
        }
        
        .patch.draggable {
            display: block;
        }
        
        .text-patch {
            position: absolute;
            cursor: move;
            display: none;
            transition: transform 0.2s ease;
            touch-action: none;
            padding: 5px;
            border-radius: 4px;
            user-select: none;
            white-space: pre-line; /* Changed to pre-line to support line breaks */
            background-color: transparent;
            resize: both;
            overflow: hidden;
            transform-origin: center center;
            word-wrap: break-word;
            max-width: 100%;
            line-height: 1.2;
        }
        
        .text-patch.draggable {
            display: block;
        }
        
        .patch:hover, .text-patch:hover {
            transform: scale(1.05);
            z-index: 10;
        }
        
        .patch.selected, .text-patch.selected {
            box-shadow: 0 0 0 2px var(--od-gold);
        }
        
        .patch-controls {
            position: absolute;
            top: -35px;
            left: 0;
            display: none;
            gap: 5px;
            z-index: 20;
        }
        
        .patch.selected .patch-controls, .text-patch.selected .patch-controls {
            display: flex;
        }
        
        .control-btn {
            background: var(--od-offwhite);
            color: var(--od-charcoal);
            border: 1px solid var(--od-taupe);
            border-radius: 4px;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
        }
        
        .control-btn:hover {
            background: var(--od-gold);
            color: var(--od-offwhite);
            transform: scale(1.1);
        }
        
        .delete-btn {
            position: absolute;
            top: -10px;
            right: -10px;
            background: #c53030;
            color: #fff;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 14px;
            display: none;
            z-index: 20;
        }
        
        .patch.selected .delete-btn, .text-patch.selected .delete-btn {
            display: flex;
        }
        
        .section-btn {
            background: var(--od-offwhite);
            color: var(--od-charcoal);
            font-family: 'Inter', sans-serif;
            font-weight: 500;
            padding: 10px 20px;
            border-radius: 6px;
            border: 1px solid var(--od-taupe);
            transition: all 0.3s ease;
        }
        
        .section-btn:hover {
            background: var(--od-gold);
            color: var(--od-offwhite);
            transform: translateY(-2px);
        }
        
        .section-btn.active {
            background: var(--od-gold);
            color: var(--od-offwhite);
            box-shadow: 0 4px 12px rgba(196, 167, 71, 0.2);
        }
        
        .custom-btn {
            background: var(--od-offwhite);
            color: var(--od-charcoal);
            font-family: 'Inter', sans-serif;
            font-weight: 500;
            padding: 12px 20px;
            border-radius: 6px;
            border: 1px solid var(--od-taupe);
            transition: all 0.3s ease;
            width: 100%;
        }
        
        .custom-btn:hover {
            background: var(--od-gold);
            color: var(--od-offwhite);
            transform: translateY(-2px);
        }
        
        .custom-btn.accent {
            background: var(--od-gold);
            color: var(--od-offwhite);
        }
        
        .custom-btn.accent:hover {
            background: var(--od-gold-light);
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.3);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .modal-content {
            background: var(--od-offwhite);
            padding: 20px;
            border-radius: 12px;
            max-width: 600px;
            width: 100%;
            position: relative;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            gap: 15px;
            border: 1px solid var(--od-taupe);
        }
        
        .modal-content img {
            max-width: 100%;
            max-height: 400px;
            width: auto;
            height: auto;
            display: block;
            margin: 0 auto;
        }
        
        .close-modal {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 24px;
            cursor: pointer;
            color: var(--od-charcoal);
            z-index: 1001;
        }
        
        .cropper-container {
            max-height: 400px;
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }
        
        .crop-controls {
            display: flex;
            flex-direction: column;
            gap: 10px;
            width: 100%;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            z-index: 1001;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transform: translateX(120%);
            transition: transform 0.3s ease;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification.success {
            background: #10b981;
        }
        
        .notification.error {
            background: #ef4444;
        }
        
        .notification.info {
            background: var(--od-gold);
            color: var(--od-offwhite);
        }
        
        .loading {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.3);
            z-index: 1002;
            justify-content: center;
            align-items: center;
        }
        
        .loading.active {
            display: flex;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top-color: var(--od-gold);
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        input, select, textarea {
            background: var(--od-offwhite);
            border: 1px solid var(--od-taupe);
            color: var(--od-charcoal);
            border-radius: 6px;
            padding: 12px;
            font-size: 16px;
            width: 100%;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--od-gold);
        }
        
        .checkbox-container {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .checkbox-container input[type="checkbox"] {
            width: 20px;
            height: 20px;
            accent-color: var(--od-gold);
        }
        
        .logo-container {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .logo-symbol {
            width: 40px;
            height: 40px;
            background: var(--od-gold);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--od-offwhite);
            font-family: 'Bebas Neue', cursive;
            font-weight: 700;
            font-size: 18px;
        }

        /* Jacket image styles */
        .jacket-option {
            width: 80px;
            height: 80px;
            border-radius: 8px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s ease;
            overflow: hidden;
            background-size: cover;
            background-position: center;
        }
        
        .jacket-option:hover, .jacket-option.active {
            transform: scale(1.1);
            border-color: var(--od-gold);
        }
        
        .jacket-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-top: 10px;
        }
        
        /* Text editor styles */
        .font-option {
            padding: 8px 12px;
            border: 1px solid var(--od-taupe);
            border-radius: 4px;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s ease;
            font-size: 14px;
            font-family: 'Inter', sans-serif; /* Default fallback */
        }
        
        .font-option:hover, .font-option.active {
            background: var(--od-gold);
            color: var(--od-offwhite);
        }
        
        .font-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-top: 10px;
            max-height: 200px;
            overflow-y: auto;
            padding: 5px;
        }

        /* Mobile-specific improvements */
        .mobile-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .mobile-btn {
            padding: 12px;
            font-size: 14px;
            flex: 1;
        }

        /* Touch-friendly improvements */
        @media (max-width: 768px) {
            .hero {
                padding: 40px 0;
            }
            
            .jacket-container {
                height: 300px;
                padding: 10px;
            }
            
            .jacket-section {
                padding: 10px;
            }
            
            .custom-btn {
                padding: 15px;
                font-size: 16px;
            }
            
            .section-btn {
                padding: 12px 16px;
                font-size: 14px;
            }
            
            .control-btn {
                width: 35px;
                height: 35px;
                font-size: 16px;
            }
            
            .delete-btn {
                width: 25px;
                height: 25px;
                font-size: 16px;
            }
            
            .patch-controls {
                top: -40px;
            }
            
            h1 {
                font-size: 2rem !important;
            }
            
            h2 {
                font-size: 1.5rem !important;
            }
            
            .container {
                padding-left: 15px;
                padding-right: 15px;
            }
            
            .jacket-grid {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .font-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .jacket-option {
                width: 70px;
                height: 70px;
            }
        }

        @media (max-width: 480px) {
            .jacket-container {
                height: 250px;
            }
            
            .hero {
                padding: 30px 0;
            }
            
            h1 {
                font-size: 1.75rem !important;
            }
            
            .jacket-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .jacket-option {
                width: 60px;
                height: 60px;
            }
            
            .font-grid {
                grid-template-columns: repeat(2, 1fr);
                max-height: 150px;
            }
        }

        /* Font preview classes - ORIGINAL + ACADEMY + ARABIC */
        .font-bebas { font-family: 'Bebas Neue', cursive !important; }
        .font-oswald { font-family: 'Oswald', sans-serif !important; }
        .font-anton { font-family: 'Anton', sans-serif !important; }
        .font-archivo { font-family: 'Archivo Black', sans-serif !important; }
        .font-blackops { font-family: 'Black Ops One', cursive !important; }
        .font-russo { font-family: 'Russo One', sans-serif !important; }
        .font-orbitron { font-family: 'Orbitron', sans-serif !important; }
        .font-audiowide { font-family: 'Audiowide', cursive !important; }
        .font-permanent { font-family: 'Permanent Marker', cursive !important; }
        .font-rocksalt { font-family: 'Rock Salt', cursive !important; }
        .font-pressstart { font-family: 'Press Start 2P', cursive !important; }
        .font-monoton { font-family: 'Monoton', cursive !important; }
        .font-iceberg { font-family: 'Iceberg', cursive !important; }
        .font-plaster { font-family: 'Plaster', cursive !important; }
        .font-stardos { font-family: 'Stardos Stencil', cursive !important; }
        .font-abril { font-family: 'Abril Fatface', cursive !important; }
        .font-playfair { font-family: 'Playfair Display', serif !important; }
        .font-pacifico { font-family: 'Pacifico', cursive !important; }
        .font-dancing { font-family: 'Dancing Script', cursive !important; }
        .font-greatvibes { font-family: 'Great Vibes', cursive !important; }
        .font-allura { font-family: 'Allura', cursive !important; }
        .font-mrdehaviland { font-family: 'Mr De Haviland', cursive !important; }
        .font-brush { font-family: 'Brush Script MT', cursive !important; }
        .font-lucida { font-family: 'Lucida Handwriting', cursive !important; }
        .font-franklin { font-family: 'Franklin Gothic Heavy', sans-serif !important; }
        .font-cooper { font-family: 'Cooper Black', serif !important; }
        .font-impact { font-family: Impact, Charcoal, sans-serif !important; }
        .font-arial { font-family: 'Arial Black', Gadget, sans-serif !important; }
        .font-rockwell { font-family: Rockwell, 'Courier Bold', Courier, Georgia, Times, 'Times New Roman', serif !important; }
        .font-academy { 
            font-family: 'Bebas Neue', cursive !important; 
            letter-spacing: 2px !important;
            font-weight: bold !important;
        }
        
        /* Arabic Fonts - FIXED: Added proper RTL support and font-family definitions */
        .font-amiri { 
            font-family: 'Amiri', serif !important; 
            direction: rtl !important; 
            unicode-bidi: bidi-override !important;
        }
        .font-lateef { 
            font-family: 'Lateef', serif !important; 
            direction: rtl !important; 
            unicode-bidi: bidi-override !important;
        }
        .font-scheherazade { 
            font-family: 'Scheherazade New', serif !important; 
            direction: rtl !important; 
            unicode-bidi: bidi-override !important;
        }
        .font-noto-naskh { 
            font-family: 'Noto Naskh Arabic', serif !important; 
            direction: rtl !important; 
            unicode-bidi: bidi-override !important;
        }
        .font-noto-sans-arabic { 
            font-family: 'Noto Sans Arabic', sans-serif !important; 
            direction: rtl !important; 
            unicode-bidi: bidi-override !important;
        }
        .font-el-messiri { 
            font-family: 'El Messiri', sans-serif !important; 
            direction: rtl !important; 
            unicode-bidi: bidi-override !important;
        }
        .font-reem-kufi { 
            font-family: 'Reem Kufi', sans-serif !important; 
            direction: rtl !important; 
            unicode-bidi: bidi-override !important;
        }
        .font-markazi { 
            font-family: 'Markazi Text', serif !important; 
            direction: rtl !important; 
            unicode-bidi: bidi-override !important;
        }
        .font-almarai { 
            font-family: 'Almarai', sans-serif !important; 
            direction: rtl !important; 
            unicode-bidi: bidi-override !important;
        }
        .font-tajawal { 
            font-family: 'Tajawal', sans-serif !important; 
            direction: rtl !important; 
            unicode-bidi: bidi-override !important;
        }
        .font-changa { 
            font-family: 'Changa', sans-serif !important; 
            direction: rtl !important; 
            unicode-bidi: bidi-override !important;
        }
        .font-jomhuria { 
            font-family: 'Jomhuria', cursive !important; 
            direction: rtl !important; 
            unicode-bidi: bidi-override !important;
        }
        .font-rakkas { 
            font-family: 'Rakkas', cursive !important; 
            direction: rtl !important; 
            unicode-bidi: bidi-override !important;
        }
        .font-mada { 
            font-family: 'Mada', sans-serif !important; 
            direction: rtl !important; 
            unicode-bidi: bidi-override !important;
        }
    </style>
</head>
<body class="min-h-screen">
    <!-- Notifications -->
    <div id="notifications"></div>
    
    <!-- Loading Indicator -->
    <div id="loading" class="loading">
        <div class="loading-spinner"></div>
    </div>
    
    <!-- Header -->
    <header class="od-bg-offwhite border-b od-border">
        <div class="container mx-auto px-4 py-4">
            <div class="flex justify-between items-center">
                <div class="logo-container">
                    <div class="logo-symbol">OD</div>
                    <div class="logo text-xl md:text-2xl od-accent">OD COUTURE</div>
                </div>
                <nav class="hidden md:flex space-x-8">
                    <a href="#" class="od-text-dark hover:od-accent transition">Collections</a>
                    <a href="#" class="od-text-dark hover:od-accent transition">Customize</a>
                    <a href="#" class="od-text-dark hover:od-accent transition">About</a>
                    <a href="#" class="od-text-dark hover:od-accent transition">Contact</a>
                </nav>
                <button class="md:hidden od-text-dark" onclick="toggleMobileMenu()">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                    </svg>
                </button>
            </div>
            <!-- Mobile Menu -->
            <div id="mobileMenu" class="md:hidden mt-4 hidden">
                <div class="flex flex-col space-y-3">
                    <a href="#" class="od-text-dark hover:od-accent transition py-2">Collections</a>
                    <a href="#" class="od-text-dark hover:od-accent transition py-2">Customize</a>
                    <a href="#" class="od-text-dark hover:od-accent transition py-2">About</a>
                    <a href="#" class="od-text-dark hover:od-accent transition py-2">Contact</a>
                </div>
            </div>
        </div>
    </header>
    
    <div class="hero">
        <div class="container mx-auto text-center relative z-10 px-4">
            <h1 class="text-3xl md:text-5xl font-bold mb-4 logo od-text-dark">Senior Jacket Couture</h1>
            <p class="text-lg md:text-xl od-text-dark max-w-2xl mx-auto">Craft your legacy with premium custom jackets that define your journey</p>
        </div>
    </div>
    
    <div class="container mx-auto p-4 md:p-6 max-w-6xl mt-6 md:mt-8">
        <div class="flex flex-col lg:flex-row gap-6 md:gap-8">
            <!-- Design Area -->
            <div class="w-full lg:w-1/2 od-bg-offwhite rounded-xl shadow-sm p-6 md:p-8 border od-border">
                <h2 class="text-2xl md:text-3xl font-semibold mb-6 od-text-dark" style="font-family: 'Bebas Neue', cursive;">Design Your Masterpiece</h2>
                <p class="od-text-dark mb-6">Start by selecting your jacket style, then add custom patches and text.</p>
                
                <!-- REORGANIZED: Jacket Selection First -->
                <div class="mb-6 border-b pb-6 border-od-taupe">
                    <h3 class="text-xl font-semibold mb-4 od-text-dark">1. Select Jacket Style</h3>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block od-text-dark font-medium mb-2">Jacket Base Color:</label>
                            <div class="jacket-grid" id="jacketOptions">
                                <!-- Jacket options will be populated by JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- REORGANIZED: Upload Section Second -->
                <div class="mb-6 border-b pb-6 border-od-taupe">
                    <h3 class="text-xl font-semibold mb-4 od-text-dark">2. Add Custom Patches</h3>
                    <label class="block od-text-dark font-medium mb-2">Upload Your Custom Patch:</label>
                    <input type="file" id="patchUpload" accept="image/*" class="mb-4 p-2 border od-border rounded-lg w-full">
                    <button onclick="openCropModal()" class="custom-btn accent">Add Patch</button>
                </div>

                <!-- REORGANIZED: Text Editor Section Third -->
                <div class="mb-6 border-b pb-6 border-od-taupe">
                    <h3 class="text-xl font-semibold mb-4 od-text-dark">3. Add Custom Text</h3>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block od-text-dark font-medium mb-2">Text Content:</label>
                            <textarea id="textContent" placeholder="Enter your text here (press Enter for new line)" class="p-2 border od-border rounded-lg w-full" rows="4"></textarea>
                        </div>
                        
                        <div>
                            <label class="block od-text-dark font-medium mb-2">Font Family:</label>
                            <div class="font-grid" id="fontGrid">
                                <!-- Font options will be populated by JavaScript -->
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block od-text-dark font-medium mb-2">Text Size:</label>
                                <input type="range" id="textSize" min="8" max="164" value="24" class="w-full">
                                <div class="text-center text-sm od-text-dark" id="textSizeValue">24px</div>
                            </div>
                            
                            <div>
                                <label class="block od-text-dark font-medium mb-2">Text Color:</label>
                                <input type="color" id="textColor" value="#000000" class="w-full h-10 rounded border od-border">
                            </div>
                        </div>
                        
                        <div class="checkbox-container">
                            <input type="checkbox" id="textBold">
                            <label for="textBold" class="od-text-dark">Bold Text</label>
                        </div>
                        
                        <div class="checkbox-container">
                            <input type="checkbox" id="textItalic">
                            <label for="textItalic" class="od-text-dark">Italic Text</label>
                        </div>
                        
                        <button onclick="addTextToJacket()" class="custom-btn accent w-full">Add Text to Jacket</button>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-8">
                    <button onclick="clearPatches()" class="custom-btn border-red-300 text-red-700 hover:bg-red-50">Reset Design</button>
                    <button onclick="saveDesign()" class="custom-btn accent">Save Design</button>
                    <button onclick="exportDesign()" class="custom-btn md:col-span-2 accent">Export Final Design</button>
                </div>

                <!-- Mobile Quick Actions -->
                <div class="mobile-actions md:hidden">
                    <button onclick="switchSection('front')" class="custom-btn accent mobile-btn">Front</button>
                    <button onclick="switchSection('back')" class="custom-btn accent mobile-btn">Back</button>
                </div>
            </div>

            <!-- Mockup Area -->
            <div class="w-full lg:w-1/2 od-bg-offwhite rounded-xl shadow-sm p-6 md:p-8 border od-border">
                <h2 class="text-2xl md:text-3xl font-semibold mb-6 od-text-dark" style="font-family: 'Bebas Neue', cursive;">Jacket Preview</h2>
                <p class="od-text-dark mb-6">Visualize your custom design in real-time.</p>
                
                <!-- Section Toggle Buttons -->
                <div class="hidden md:flex justify-center gap-4 mb-6">
                    <button onclick="switchSection('front')" class="section-btn active">Front</button>
                    <button onclick="switchSection('back')" class="section-btn">Back</button>
                </div>
                
                <!-- Jacket Container -->
                <div class="jacket-container" id="jacket-container">
                    <div class="jacket-section active" id="front-section" style="background-image: url('select.png');"></div>
                    <div class="jacket-section" id="back-section" style="background-image: url('select.png');"></div>
                </div>

                <!-- Mobile Instructions -->
                <div class="mt-4 text-sm od-text-light text-center md:hidden">
                    <p>💡 Tap and hold patches to move them</p>
                    <p>📱 Use two fingers to resize patches</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Crop Modal -->
    <div id="cropModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeCropModal()">&times;</span>
            <h3 class="text-xl font-semibold mb-4 od-text-dark">Customize Your Patch</h3>
            <div class="cropper-container">
                <img id="cropImage" src="" alt="Image to crop">
            </div>
            <div class="crop-controls">
                <div>
                    <label class="block od-text-dark font-medium mb-2">Patch Size (px):</label>
                    <input type="number" id="patchSize" value="80" min="20" max="200" class="p-2 border od-border rounded-lg w-full mb-4">
                </div>
                
                <!-- KEPT ALL BACKGROUND REMOVAL OPTIONS -->
                <div class="mb-4">
                    <label class="block od-text-dark font-medium mb-2">Background Removal:</label>
                    <div class="space-y-2">
                        <div class="checkbox-container">
                            <input type="checkbox" id="removeWhiteBackground" checked>
                            <label for="removeWhiteBackground" class="od-text-dark">Remove white background</label>
                        </div>
                        <div class="checkbox-container">
                            <input type="checkbox" id="removeBlackBackground">
                            <label for="removeBlackBackground" class="od-text-dark">Remove black background</label>
                        </div>
                        <div class="checkbox-container">
                            <input type="checkbox" id="removeTransparent">
                            <label for="removeTransparent" class="od-text-dark">Make transparent background</label>
                        </div>
                    </div>
                </div>
                
                <div class="mb-4">
                    <label class="block od-text-dark font-medium mb-2">Background Removal Sensitivity:</label>
                    <input type="range" id="bgSensitivity" min="0" max="100" value="30" class="w-full">
                    <div class="text-center text-sm od-text-dark" id="bgSensitivityValue">30%</div>
                </div>
                
                <button onclick="cropAndAddPatch()" class="custom-btn accent">Apply Patch</button>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="od-bg-offwhite border-t od-border mt-12 py-8">
        <div class="container mx-auto px-4">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <div class="logo-container mb-4 md:mb-0">
                    <div class="logo-symbol">OD</div>
                    <div class="logo text-xl od-accent">OD COUTURE</div>
                </div>
                <div class="od-text-dark text-sm text-center md:text-left mb-4 md:mb-0">
                    &copy; 2025 OD Couture. All rights reserved.
                </div>
                <div class="flex space-x-4">
                    <a href="#" class="od-text-dark hover:od-accent transition">Terms</a>
                    <a href="#" class="od-text-dark hover:od-accent transition">Privacy</a>
                    <a href="#" class="od-text-dark hover:od-accent transition">Contact</a>
                </div>
            </div>
        </div>
    </footer>

    <!-- Share Buttons -->
    <div class="fixed bottom-4 right-4 flex flex-col gap-2 z-50">
        <button onclick="shareToWhatsApp()" class="bg-green-500 text-white p-3 rounded-full shadow-lg">
            📱
        </button>
        <button onclick="shareLink()" class="bg-blue-500 text-white p-3 rounded-full shadow-lg">
            🔗
        </button>
    </div>

    <script>
        // Jacket image data - KEEPING ORIGINAL IMAGE NAMES
        const jacketImages = {
            'black': {
                front: 'Untitled-1.png',
                back: 'Untitled-2.png'
            },
            'navy': {
                front: 'Untitled-3.png',
                back: 'Untitled-4.png'
            },
            'red': {
                front: 'Untitled-5.png',
                back: 'Untitled-6.png'
            },
            'green': {
                front: 'Untitled-7.png',
                back: 'Untitled-8.png'
            },
            'purple': {
                front: 'Untitled-9.png',
                back: 'Untitled-10.png'
            },
            'white': {
                front: 'Untitled-11.png',
                back: 'Untitled-12.png'
            },
            'grey': {
                front: 'Untitled-13.png',
                back: 'Untitled-14.png'
            },
            'beige': {
                front: 'Untitled-15.png',
                back: 'Untitled-16.png'
            }
        };

        // Font data with proper display names and classes
        const fontOptions = [
            // Varsity/Block Fonts
            { name: 'VARSITY', font: 'Bebas Neue', class: 'font-bebas' },
            { name: 'OSWALD', font: 'Oswald', class: 'font-oswald' },
            { name: 'ANTON', font: 'Anton', class: 'font-anton' },
            { name: 'ARCHIVO', font: 'Archivo Black', class: 'font-archivo' },
            { name: 'IMPACT', font: 'Impact', class: 'font-impact' },
            { name: 'ARIAL', font: 'Arial Black', class: 'font-arial' },
            { name: 'BLACK OPS', font: 'Black Ops One', class: 'font-blackops' },
            { name: 'RUSSO', font: 'Russo One', class: 'font-russo' },
            { name: 'ACADEMY', font: 'Bebas Neue', class: 'font-academy' },
            
            // Tech/Modern Fonts
            { name: 'ORBITRON', font: 'Orbitron', class: 'font-orbitron' },
            { name: 'AUDIO', font: 'Audiowide', class: 'font-audiowide' },
            { name: 'RETRO', font: 'Press Start 2P', class: 'font-pressstart' },
            { name: 'MONOTON', font: 'Monoton', class: 'font-monoton' },
            { name: 'ICEBERG', font: 'Iceberg', class: 'font-iceberg' },
            { name: 'PLASTER', font: 'Plaster', class: 'font-plaster' },
            { name: 'STENCIL', font: 'Stardos Stencil', class: 'font-stardos' },
            
            // Script & Elegant Fonts
            { name: 'BRUSH', font: 'Brush Script MT', class: 'font-brush' },
            { name: 'LUCIDA', font: 'Lucida Handwriting', class: 'font-lucida' },
            { name: 'PACIFICO', font: 'Pacifico', class: 'font-pacifico' },
            { name: 'DANCING', font: 'Dancing Script', class: 'font-dancing' },
            { name: 'GREAT VIBES', font: 'Great Vibes', class: 'font-greatvibes' },
            { name: 'ALLURA', font: 'Allura', class: 'font-allura' },
            { name: 'HAVILAND', font: 'Mr De Haviland', class: 'font-mrdehaviland' },
            { name: 'MARKER', font: 'Permanent Marker', class: 'font-permanent' },
            { name: 'ROCK SALT', font: 'Rock Salt', class: 'font-rocksalt' },
            
            // Classic Fonts
            { name: 'FRANKLIN', font: 'Franklin Gothic Heavy', class: 'font-franklin' },
            { name: 'COOPER', font: 'Cooper Black', class: 'font-cooper' },
            { name: 'ROCKWELL', font: 'Rockwell', class: 'font-rockwell' },
            { name: 'ABRIL', font: 'Abril Fatface', class: 'font-abril' },
            { name: 'PLAYFAIR', font: 'Playfair Display', class: 'font-playfair' },
            
            // Arabic Fonts - FIXED: Added proper RTL support
            { name: 'عربي - Amiri', font: 'Amiri', class: 'font-amiri' },
            { name: 'عربي - Lateef', font: 'Lateef', class: 'font-lateef' },
            { name: 'عربي - Scheherazade', font: 'Scheherazade New', class: 'font-scheherazade' },
            { name: 'عربي - Noto Naskh', font: 'Noto Naskh Arabic', class: 'font-noto-naskh' },
            { name: 'عربي - Noto Sans', font: 'Noto Sans Arabic', class: 'font-noto-sans-arabic' },
            { name: 'عربي - El Messiri', font: 'El Messiri', class: 'font-el-messiri' },
            { name: 'عربي - Reem Kufi', font: 'Reem Kufi', class: 'font-reem-kufi' },
            { name: 'عربي - Markazi', font: 'Markazi Text', class: 'font-markazi' },
            { name: 'عربي - Almarai', font: 'Almarai', class: 'font-almarai' },
            { name: 'عربي - Tajawal', font: 'Tajawal', class: 'font-tajawal' },
            { name: 'عربي - Changa', font: 'Changa', class: 'font-changa' },
            { name: 'عربي - Jomhuria', font: 'Jomhuria', class: 'font-jomhuria' },
            { name: 'عربي - Rakkas', font: 'Rakkas', class: 'font-rakkas' },
            { name: 'عربي - Mada', font: 'Mada', class: 'font-mada' }
        ];

        // Main application class
        class JacketCustomizer {
            constructor() {
                this.patchCounter = 0;
                this.textCounter = 0;
                this.currentSection = 'front';
                this.cropper = null;
                this.uploadedImageUrl = null;
                this.selectedPatch = null;
                this.patches = {
                    front: [],
                    back: []
                };
                this.texts = {
                    front: [],
                    back: []
                };
                this.currentJacket = 'black'; // Default jacket
                this.currentFont = 'Bebas Neue'; // Default font
                
                this.init();
            }

            init() {
                this.bindEvents();
                this.setupFontOptions();
                this.switchSection('front');
                this.loadDesign();
                this.setupMobileInteractions();
                this.setupTextControls();
                this.setupJacketOptions();
                this.setupBackgroundRemovalControls();
                this.preloadFonts();
            }

            bindEvents() {
                document.getElementById('patchUpload').addEventListener('change', this.handleImageUpload.bind(this));
                document.addEventListener('click', this.deselectPatches.bind(this));
                
                // Add Enter key handler for textarea to prevent form submission
                document.getElementById('textContent').addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        // Just allow the default behavior which adds a new line
                    }
                });
            }

            setupFontOptions() {
                const fontGrid = document.getElementById('fontGrid');
                fontGrid.innerHTML = '';
                
                fontOptions.forEach((fontOption, index) => {
                    const fontElement = document.createElement('div');
                    fontElement.className = `font-option ${fontOption.class} ${index === 0 ? 'active' : ''}`;
                    fontElement.setAttribute('data-font', fontOption.font);
                    fontElement.textContent = fontOption.name;
                    fontElement.onclick = () => this.selectFont(fontElement, fontOption.font, fontOption.class);
                    
                    fontGrid.appendChild(fontElement);
                });
            }

            // Preload fonts to ensure they work on GitHub Pages
            preloadFonts() {
                // Create a hidden div with all fonts to force preloading
                const fontPreloader = document.createElement('div');
                fontPreloader.style.position = 'absolute';
                fontPreloader.style.left = '-9999px';
                fontPreloader.style.top = '-9999px';
                fontPreloader.style.opacity = '0';
                fontPreloader.style.pointerEvents = 'none';
                
                fontOptions.forEach(fontOption => {
                    const sample = document.createElement('div');
                    sample.className = fontOption.class;
                    sample.textContent = 'Font Test';
                    fontPreloader.appendChild(sample);
                });
                
                document.body.appendChild(fontPreloader);
                
                // Remove after a short delay
                setTimeout(() => {
                    document.body.removeChild(fontPreloader);
                }, 1000);
            }

            selectFont(element, font, fontClass) {
                document.querySelectorAll('.font-option').forEach(opt => opt.classList.remove('active'));
                element.classList.add('active');
                this.currentFont = font;
                this.currentFontClass = fontClass;
            }

            setupMobileInteractions() {
                // Prevent zoom on double tap
                document.addEventListener('touchstart', function(e) {
                    if (e.touches.length > 1) {
                        e.preventDefault();
                    }
                }, { passive: false });

                let lastTouchEnd = 0;
                document.addEventListener('touchend', function(e) {
                    const now = (new Date()).getTime();
                    if (now - lastTouchEnd <= 300) {
                        e.preventDefault();
                    }
                    lastTouchEnd = now;
                }, false);
            }

            setupTextControls() {
                // Update text size value display
                const textSizeSlider = document.getElementById('textSize');
                const textSizeValue = document.getElementById('textSizeValue');
                
                textSizeSlider.addEventListener('input', function() {
                    textSizeValue.textContent = this.value + 'px';
                });
            }

            setupBackgroundRemovalControls() {
                // Update background removal sensitivity value display
                const bgSensitivitySlider = document.getElementById('bgSensitivity');
                const bgSensitivityValue = document.getElementById('bgSensitivityValue');
                
                bgSensitivitySlider.addEventListener('input', function() {
                    bgSensitivityValue.textContent = this.value + '%';
                });
            }

            setupJacketOptions() {
                const jacketGrid = document.getElementById('jacketOptions');
                jacketGrid.innerHTML = '';
                
                Object.keys(jacketImages).forEach(color => {
                    const jacketOption = document.createElement('div');
                    jacketOption.className = `jacket-option ${color === this.currentJacket ? 'active' : ''}`;
                    jacketOption.style.backgroundImage = `url('${jacketImages[color].front}')`;
                    jacketOption.setAttribute('data-color', color);
                    jacketOption.setAttribute('title', color.charAt(0).toUpperCase() + color.slice(1));
                    jacketOption.onclick = () => this.selectJacket(color);
                    
                    jacketGrid.appendChild(jacketOption);
                });
            }

            selectJacket(color) {
                this.currentJacket = color;
                
                // Update active state
                document.querySelectorAll('.jacket-option').forEach(opt => {
                    opt.classList.remove('active');
                });
                document.querySelector(`.jacket-option[data-color="${color}"]`).classList.add('active');
                
                // Update jacket images
                this.updateJacketImages();
                this.showNotification(`${color.charAt(0).toUpperCase() + color.slice(1)} jacket selected`, 'info');
            }

            updateJacketImages() {
                const frontSection = document.getElementById('front-section');
                const backSection = document.getElementById('back-section');
                
                frontSection.style.backgroundImage = `url('${jacketImages[this.currentJacket].front}')`;
                backSection.style.backgroundImage = `url('${jacketImages[this.currentJacket].back}')`;
            }

            handleImageUpload(e) {
                const file = e.target.files[0];
                if (file) {
                    // Validate file type
                    if (!file.type.match('image.*')) {
                        this.showNotification('Please select a valid image file', 'error');
                        return;
                    }
                    
                    // Validate file size (max 5MB)
                    if (file.size > 5 * 1024 * 1024) {
                        this.showNotification('Image size should be less than 5MB', 'error');
                        return;
                    }
                    
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        this.uploadedImageUrl = event.target.result;
                        this.showNotification('Image uploaded successfully! Click "Add Patch" to customize it.', 'success');
                    };
                    reader.readAsDataURL(file);
                }
            }

            // Section Switching
            switchSection(section) {
                this.currentSection = section;
                document.querySelectorAll('.jacket-section').forEach(el => el.classList.remove('active'));
                document.getElementById(`${section}-section`).classList.add('active');
                
                document.querySelectorAll('.section-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                const desktopBtn = document.querySelector(`button[onclick="switchSection('${section}')"]`);
                if (desktopBtn) desktopBtn.classList.add('active');
                
                this.updatePatches();
                this.updateTexts();
            }

            // Update displayed patches for current section
            updatePatches() {
                document.querySelectorAll('.patch').forEach(patch => patch.remove());
                this.patches[this.currentSection].forEach(patch => {
                    this.createPatchElement(patch);
                });
            }

            // Update displayed texts for current section
            updateTexts() {
                document.querySelectorAll('.text-patch').forEach(text => text.remove());
                this.texts[this.currentSection].forEach(text => {
                    this.createTextElement(text);
                });
            }

            // Create patch element
            createPatchElement(patch) {
                const el = document.createElement('div');
                el.className = 'patch draggable';
                el.id = patch.id;
                el.style.backgroundImage = `url(${patch.image})`;
                el.style.left = patch.left;
                el.style.top = patch.top;
                el.style.width = patch.width;
                el.style.height = patch.height;
                
                // Add rotation if it exists
                if (patch.rotation) {
                    el.style.transform = `rotate(${patch.rotation}deg)`;
                }
                
                this.addPatchControls(el, patch.id);
                this.makeDraggableAndResizable(el);
                document.getElementById(`${this.currentSection}-section`).appendChild(el);
            }

            // Create text element
            createTextElement(text) {
                const el = document.createElement('div');
                el.className = `text-patch draggable ${text.fontClass || ''}`;
                el.id = text.id;
                el.textContent = text.content;
                el.style.left = text.left;
                el.style.top = text.top;
                el.style.fontFamily = text.fontFamily;
                el.style.fontSize = text.fontSize + 'px';
                el.style.color = text.color;
                el.style.fontWeight = text.bold ? 'bold' : 'normal';
                el.style.fontStyle = text.italic ? 'italic' : 'normal';
                el.style.lineHeight = '1.2'; // Better line spacing for paragraphs
                
                // Handle RTL for Arabic fonts - FIXED: Added proper RTL support
                if (text.fontFamily.includes('Amiri') || text.fontFamily.includes('Lateef') || 
                    text.fontFamily.includes('Scheherazade') || text.fontFamily.includes('Noto') ||
                    text.fontFamily.includes('El Messiri') || text.fontFamily.includes('Reem Kufi') ||
                    text.fontFamily.includes('Markazi') || text.fontFamily.includes('Almarai') ||
                    text.fontFamily.includes('Tajawal') || text.fontFamily.includes('Changa') ||
                    text.fontFamily.includes('Jomhuria') || text.fontFamily.includes('Rakkas') ||
                    text.fontFamily.includes('Mada')) {
                    el.style.direction = 'rtl';
                    el.style.textAlign = 'right';
                    el.style.unicodeBidi = 'bidi-override';
                }
                
                // Add rotation if it exists
                if (text.rotation) {
                    el.style.transform = `rotate(${text.rotation}deg)`;
                }
                
                this.addPatchControls(el, text.id);
                this.makeDraggableAndResizable(el);
                document.getElementById(`${this.currentSection}-section`).appendChild(el);
            }

            // Add controls to patches and texts
            addPatchControls(el, id) {
                // Create control buttons
                const controls = document.createElement('div');
                controls.className = 'patch-controls';
                
                // Rotate left button
                const rotateLeftBtn = document.createElement('button');
                rotateLeftBtn.className = 'control-btn';
                rotateLeftBtn.innerHTML = '↶';
                rotateLeftBtn.title = 'Rotate Left';
                rotateLeftBtn.onclick = (e) => {
                    e.stopPropagation();
                    this.rotateElement(id, -15);
                };
                
                // Rotate right button
                const rotateRightBtn = document.createElement('button');
                rotateRightBtn.className = 'control-btn';
                rotateRightBtn.innerHTML = '↷';
                rotateRightBtn.title = 'Rotate Right';
                rotateRightBtn.onclick = (e) => {
                    e.stopPropagation();
                    this.rotateElement(id, 15);
                };
                
                // Add buttons to controls
                controls.appendChild(rotateLeftBtn);
                controls.appendChild(rotateRightBtn);
                
                // Delete button
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-btn';
                deleteBtn.innerHTML = '&times;';
                deleteBtn.onclick = () => this.deleteElement(id);
                
                el.appendChild(controls);
                el.appendChild(deleteBtn);
            }

            // Rotate element (patch or text)
            rotateElement(elementId, degrees) {
                // Check if it's a patch
                let elementIndex = this.patches[this.currentSection].findIndex(p => p.id === elementId);
                if (elementIndex !== -1) {
                    const patch = this.patches[this.currentSection][elementIndex];
                    patch.rotation = (patch.rotation || 0) + degrees;
                    
                    const element = document.getElementById(elementId);
                    if (element) {
                        element.style.transform = `rotate(${patch.rotation}deg)`;
                    }
                    return;
                }
                
                // Check if it's a text
                elementIndex = this.texts[this.currentSection].findIndex(t => t.id === elementId);
                if (elementIndex !== -1) {
                    const text = this.texts[this.currentSection][elementIndex];
                    text.rotation = (text.rotation || 0) + degrees;
                    
                    const element = document.getElementById(elementId);
                    if (element) {
                        element.style.transform = `rotate(${text.rotation}deg)`;
                    }
                }
            }

            // Delete element (patch or text)
            deleteElement(elementId) {
                // Check if it's a patch
                let elementIndex = this.patches[this.currentSection].findIndex(p => p.id === elementId);
                if (elementIndex !== -1) {
                    this.patches[this.currentSection].splice(elementIndex, 1);
                    this.updatePatches();
                    this.showNotification('Patch deleted', 'info');
                    return;
                }
                
                // Check if it's a text
                elementIndex = this.texts[this.currentSection].findIndex(t => t.id === elementId);
                if (elementIndex !== -1) {
                    this.texts[this.currentSection].splice(elementIndex, 1);
                    this.updateTexts();
                    this.showNotification('Text deleted', 'info');
                }
            }

            // Add text to jacket
            addTextToJacket() {
                const content = document.getElementById('textContent').value.trim();
                if (!content) {
                    this.showNotification('Please enter some text', 'error');
                    return;
                }
                
                const fontFamily = this.currentFont;
                const fontClass = this.currentFontClass;
                const fontSize = parseInt(document.getElementById('textSize').value);
                const color = document.getElementById('textColor').value;
                const bold = document.getElementById('textBold').checked;
                const italic = document.getElementById('textItalic').checked;
                
                this.textCounter++;
                const textId = 'text-' + this.textCounter;
                
                const text = {
                    id: textId,
                    content: content,
                    fontFamily: fontFamily,
                    fontClass: fontClass,
                    fontSize: fontSize,
                    color: color,
                    bold: bold,
                    italic: italic,
                    left: '50px',
                    top: '100px',
                    rotation: 0
                };
                
                this.texts[this.currentSection].push(text);
                this.createTextElement(text);
                
                // Clear the text input
                document.getElementById('textContent').value = '';
                
                this.showNotification('Text added successfully!', 'success');
            }

            // Crop Modal Functions
            openCropModal() {
                if (!this.uploadedImageUrl) {
                    this.showNotification('Please upload an image first!', 'error');
                    return;
                }
                
                try {
                    const modal = document.getElementById('cropModal');
                    const cropImage = document.getElementById('cropImage');
                    cropImage.src = this.uploadedImageUrl;
                    modal.style.display = 'flex';

                    if (this.cropper) {
                        this.cropper.destroy();
                    }
                    
                    this.cropper = new Cropper(cropImage, {
                        aspectRatio: 1,
                        viewMode: 1,
                        autoCropArea: 0.8,
                        movable: true,
                        zoomable: true,
                        scalable: true,
                        cropBoxResizable: true
                    });
                } catch (error) {
                    console.error('Error initializing cropper:', error);
                    this.showNotification('Error loading image editor', 'error');
                }
            }

            closeCropModal() {
                const modal = document.getElementById('cropModal');
                modal.style.display = 'none';
                if (this.cropper) {
                    this.cropper.destroy();
                    this.cropper = null;
                }
            }

            cropAndAddPatch() {
                if (!this.cropper) {
                    this.showNotification('No image to crop', 'error');
                    return;
                }
                
                const size = parseInt(document.getElementById('patchSize').value);
                if (isNaN(size) || size < 20 || size > 200) {
                    this.showNotification('Please enter a valid size between 20 and 200 pixels', 'error');
                    return;
                }
                
                this.toggleLoading(true);
                
                try {
                    const canvas = this.cropper.getCroppedCanvas({
                        width: size * 2, // Higher resolution to prevent pixelation
                        height: size * 2
                    });
                    
                    let croppedImageUrl = canvas.toDataURL('image/png', 1.0); // High quality
                    
                    // Enhanced background removal with black background support
                    const removeWhiteBackground = document.getElementById('removeWhiteBackground').checked;
                    const removeBlackBackground = document.getElementById('removeBlackBackground').checked;
                    const makeTransparent = document.getElementById('removeTransparent').checked;
                    const sensitivity = parseInt(document.getElementById('bgSensitivity').value);
                    
                    if (removeWhiteBackground || removeBlackBackground || makeTransparent) {
                        croppedImageUrl = this.removeBackground(canvas, removeWhiteBackground, removeBlackBackground, makeTransparent, sensitivity);
                    }
                    
                    this.patchCounter++;
                    const patchId = 'patch-' + this.patchCounter;
                    
                    const patch = {
                        id: patchId,
                        image: croppedImageUrl,
                        left: '50px',
                        top: '50px',
                        width: `${size}px`,
                        height: `${size}px`,
                        rotation: 0
                    };
                    
                    this.patches[this.currentSection].push(patch);
                    this.createPatchElement(patch);
                    
                    this.uploadedImageUrl = null;
                    document.getElementById('patchUpload').value = '';
                    this.closeCropModal();
                    
                    this.showNotification('Patch added successfully!', 'success');
                } catch (error) {
                    console.error('Error cropping image:', error);
                    this.showNotification('Error processing image', 'error');
                } finally {
                    this.toggleLoading(false);
                }
            }

            // Enhanced background removal with black background support
            removeBackground(canvas, removeWhite, removeBlack, makeTransparent, sensitivity) {
                const tempCanvas = document.createElement('canvas');
                const tempCtx = tempCanvas.getContext('2d');
                
                tempCanvas.width = canvas.width;
                tempCanvas.height = canvas.height;
                
                // Draw the original image
                tempCtx.drawImage(canvas, 0, 0);
                
                // Get image data
                const imageData = tempCtx.getImageData(0, 0, tempCanvas.width, tempCanvas.height);
                const data = imageData.data;
                
                // Calculate threshold based on sensitivity
                const threshold = (sensitivity / 100) * 255;
                
                // Remove background based on settings
                for (let i = 0; i < data.length; i += 4) {
                    const r = data[i];
                    const g = data[i + 1];
                    const b = data[i + 2];
                    
                    let shouldRemove = false;
                    
                    // Check for white background removal
                    if (removeWhite) {
                        shouldRemove = shouldRemove || (r > (255 - threshold) && g > (255 - threshold) && b > (255 - threshold));
                    }
                    
                    // Check for black background removal
                    if (removeBlack) {
                        shouldRemove = shouldRemove || (r < threshold && g < threshold && b < threshold);
                    }
                    
                    // Make transparent if requested
                    if (makeTransparent) {
                        shouldRemove = true;
                    }
                    
                    // If pixel should be removed, set alpha to 0
                    if (shouldRemove) {
                        data[i + 3] = 0; // Set alpha to 0
                    }
                }
                
                // Put the modified image data back
                tempCtx.putImageData(imageData, 0, 0);
                
                return tempCanvas.toDataURL('image/png', 1.0);
            }

            // Draggable and Resizable Functionality - FIXED VERSION
            makeDraggableAndResizable(element) {
                // Draggable with touch support
                interact(element).draggable({
                    listeners: {
                        move: (event) => {
                            const target = event.target;
                            let x = (parseFloat(target.style.left) || 0) + event.dx;
                            let y = (parseFloat(target.style.top) || 0) + event.dy;

                            const sectionRect = target.parentElement.getBoundingClientRect();
                            const elementRect = target.getBoundingClientRect();
                            const maxLeft = sectionRect.width - elementRect.width;
                            const maxTop = sectionRect.height - elementRect.height;

                            x = Math.max(0, Math.min(x, maxLeft));
                            y = Math.max(0, Math.min(y, maxTop));

                            target.style.left = x + 'px';
                            target.style.top = y + 'px';

                            // Update position in data
                            this.updateElementPosition(target.id, x, y);
                        }
                    },
                    modifiers: [
                        interact.modifiers.restrictRect({
                            restriction: 'parent'
                        })
                    ]
                });

                // Resizable with fixed aspect ratio and touch support for patches
                if (element.classList.contains('patch')) {
                    interact(element).resizable({
                        edges: { left: true, right: true, bottom: true, top: true },
                        preserveAspectRatio: true,
                        listeners: {
                            move: (event) => {
                                const target = event.target;
                                let x = parseFloat(target.style.left) || 0;
                                let y = parseFloat(target.style.top) || 0;

                                target.style.width = event.rect.width + 'px';
                                target.style.height = event.rect.height + 'px';

                                x += event.deltaRect.left;
                                y += event.deltaRect.top;

                                const sectionRect = target.parentElement.getBoundingClientRect();
                                const maxLeft = sectionRect.width - event.rect.width;
                                const maxTop = sectionRect.height - event.rect.height;

                                x = Math.max(0, Math.min(x, maxLeft));
                                y = Math.max(0, Math.min(y, maxTop));

                                target.style.left = x + 'px';
                                target.style.top = y + 'px';

                                // Update size in data
                                this.updatePatchSize(target.id, target.style.width, target.style.height);
                            }
                        },
                        modifiers: [
                            interact.modifiers.restrictSize({
                                min: { width: 20, height: 20 },
                                max: { width: 200, height: 200 }
                            }),
                            interact.modifiers.restrictEdges({
                                outer: 'parent'
                            })
                        ]
                    });
                }

                // Resizable for text elements - FIXED VERSION (scales text instead of cropping)
                if (element.classList.contains('text-patch')) {
                    interact(element).resizable({
                        edges: { left: true, right: true, bottom: true, top: true },
                        preserveAspectRatio: false,
                        listeners: {
                            start: (event) => {
                                // Store original font size when starting resize
                                event.target.dataset.originalFontSize = window.getComputedStyle(event.target).fontSize;
                            },
                            move: (event) => {
                                const target = event.target;
                                let x = parseFloat(target.style.left) || 0;
                                let y = parseFloat(target.style.top) || 0;

                                target.style.width = event.rect.width + 'px';
                                target.style.height = event.rect.height + 'px';

                                x += event.deltaRect.left;
                                y += event.deltaRect.top;

                                const sectionRect = target.parentElement.getBoundingClientRect();
                                const maxLeft = sectionRect.width - event.rect.width;
                                const maxTop = sectionRect.height - event.rect.height;

                                x = Math.max(0, Math.min(x, maxLeft));
                                y = Math.max(0, Math.min(y, maxTop));

                                target.style.left = x + 'px';
                                target.style.top = y + 'px';

                                // Scale font size proportionally to width
                                const originalFontSize = parseFloat(target.dataset.originalFontSize);
                                const scaleFactor = event.rect.width / (parseFloat(target.dataset.originalWidth) || originalFontSize * 5);
                                const newFontSize = Math.max(8, Math.min(164, originalFontSize * scaleFactor));
                                
                                target.style.fontSize = newFontSize + 'px';

                                // Update size in data
                                this.updateTextSize(target.id, target.style.width, target.style.height, newFontSize);
                            }
                        },
                        modifiers: [
                            interact.modifiers.restrictSize({
                                min: { width: 50, height: 20 },
                                max: { width: 300, height: 100 }
                            }),
                            interact.modifiers.restrictEdges({
                                outer: 'parent'
                            })
                        ]
                    });
                }

                // Select element on click/tap
                element.addEventListener('click', (e) => {
                    e.stopPropagation();
                    document.querySelectorAll('.patch, .text-patch').forEach(el => el.classList.remove('selected'));
                    element.classList.add('selected');
                    this.selectedPatch = element.id;
                });

                // Store original width when text is created
                if (element.classList.contains('text-patch')) {
                    const originalFontSize = parseFloat(window.getComputedStyle(element).fontSize);
                    element.dataset.originalWidth = (originalFontSize * 5) + 'px';
                }

                // Better touch handling for mobile
                element.addEventListener('touchstart', (e) => {
                    e.stopPropagation();
                }, { passive: true });
            }

            // Update element position in data
            updateElementPosition(elementId, x, y) {
                // Check if it's a patch
                let elementIndex = this.patches[this.currentSection].findIndex(p => p.id === elementId);
                if (elementIndex !== -1) {
                    this.patches[this.currentSection][elementIndex].left = x + 'px';
                    this.patches[this.currentSection][elementIndex].top = y + 'px';
                    return;
                }
                
                // Check if it's a text
                elementIndex = this.texts[this.currentSection].findIndex(t => t.id === elementId);
                if (elementIndex !== -1) {
                    this.texts[this.currentSection][elementIndex].left = x + 'px';
                    this.texts[this.currentSection][elementIndex].top = y + 'px';
                }
            }

            // Update patch size in data
            updatePatchSize(patchId, width, height) {
                const patchIndex = this.patches[this.currentSection].findIndex(p => p.id === patchId);
                if (patchIndex !== -1) {
                    this.patches[this.currentSection][patchIndex].width = width;
                    this.patches[this.currentSection][patchIndex].height = height;
                }
            }

            // Update text size in data - FIXED METHOD
            updateTextSize(textId, width, height, fontSize) {
                const textIndex = this.texts[this.currentSection].findIndex(t => t.id === textId);
                if (textIndex !== -1) {
                    // For text, we're storing the actual dimensions and font size
                    this.texts[this.currentSection][textIndex].width = width;
                    this.texts[this.currentSection][textIndex].height = height;
                    if (fontSize) {
                        this.texts[this.currentSection][textIndex].fontSize = fontSize;
                    }
                }
            }

            // Clear Patches
            clearPatches() {
                if (this.patches[this.currentSection].length === 0 && this.texts[this.currentSection].length === 0) {
                    this.showNotification('No patches or text to clear', 'info');
                    return;
                }
                
                if (confirm('Are you sure you want to clear all patches and text from this section?')) {
                    this.patches[this.currentSection] = [];
                    this.texts[this.currentSection] = [];
                    this.updatePatches();
                    this.updateTexts();
                    this.uploadedImageUrl = null;
                    document.getElementById('patchUpload').value = '';
                    this.selectedPatch = null;
                    this.showNotification('All patches and text cleared', 'info');
                }
            }

            // Deselect patch when clicking outside
            deselectPatches(e) {
                if (!e.target.classList.contains('patch') && 
                    !e.target.classList.contains('text-patch') && 
                    !e.target.classList.contains('delete-btn') && 
                    !e.target.classList.contains('control-btn')) {
                    document.querySelectorAll('.patch, .text-patch').forEach(p => p.classList.remove('selected'));
                    this.selectedPatch = null;
                }
            }

            // Save design to localStorage
            saveDesign() {
                try {
                    const design = {
                        patches: this.patches,
                        texts: this.texts,
                        currentJacket: this.currentJacket,
                        timestamp: new Date().toISOString()
                    };
                    localStorage.setItem('jacketDesign', JSON.stringify(design));
                    this.showNotification('Design saved successfully!', 'success');
                } catch (error) {
                    console.error('Error saving design:', error);
                    this.showNotification('Error saving design', 'error');
                }
            }

            // Load design from localStorage
            loadDesign() {
                try {
                    const saved = localStorage.getItem('jacketDesign');
                    if (saved) {
                        const design = JSON.parse(saved);
                        this.patches = design.patches || { front: [], back: [] };
                        this.texts = design.texts || { front: [], back: [] };
                        this.currentJacket = design.currentJacket || 'black';
                        this.updatePatches();
                        this.updateTexts();
                        this.setupJacketOptions();
                        this.updateJacketImages();
                        this.showNotification('Design loaded successfully!', 'success');
                    }
                } catch (error) {
                    console.error('Error loading design:', error);
                    this.showNotification('Error loading saved design', 'error');
                }
            }

            // Export final design as image - FIXED VERSION
            exportDesign() {
                this.toggleLoading(true);
                
                const jacketSection = document.getElementById(`${this.currentSection}-section`);
                
                // Create a temporary container to ensure everything renders correctly
                const tempContainer = document.createElement('div');
                tempContainer.style.position = 'fixed';
                tempContainer.style.left = '-9999px';
                tempContainer.style.top = '0';
                tempContainer.style.width = jacketSection.offsetWidth + 'px';
                tempContainer.style.height = jacketSection.offsetHeight + 'px';
                tempContainer.style.background = 'white';
                tempContainer.style.zIndex = '9999';
                
                // Clone the jacket section
                const clone = jacketSection.cloneNode(true);
                clone.style.opacity = '1';
                clone.style.position = 'relative';
                clone.style.width = '100%';
                clone.style.height = '100%';
                
                tempContainer.appendChild(clone);
                document.body.appendChild(tempContainer);
                
                // Use html2canvas with better configuration
                html2canvas(clone, {
                    backgroundColor: null,
                    scale: 2,
                    useCORS: true,
                    logging: false,
                    allowTaint: false,
                    width: clone.offsetWidth,
                    height: clone.offsetHeight,
                    onclone: function(clonedDoc) {
                        // Ensure all fonts are loaded in the clone
                        const elements = clonedDoc.querySelectorAll('.text-patch');
                        elements.forEach(el => {
                            el.style.fontFamily = getComputedStyle(el).fontFamily;
                        });
                    }
                }).then(canvas => {
                    // Create download link
                    const link = document.createElement('a');
                    link.download = `senior-jacket-design-${this.currentSection}-${Date.now()}.png`;
                    link.href = canvas.toDataURL('image/png', 1.0);
                    
                    // Trigger download
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    this.showNotification('Design exported successfully!', 'success');
                }).catch(error => {
                    console.error('Error exporting design:', error);
                    this.showNotification('Error exporting design. Please try again.', 'error');
                }).finally(() => {
                    // Clean up
                    document.body.removeChild(tempContainer);
                    this.toggleLoading(false);
                });
            }

            // Show notification
            showNotification(message, type = 'info') {
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.textContent = message;
                
                const container = document.getElementById('notifications');
                container.appendChild(notification);
                
                // Show notification
                setTimeout(() => {
                    notification.classList.add('show');
                }, 10);
                
                // Remove after 3 seconds
                setTimeout(() => {
                    notification.classList.remove('show');
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                    }, 300);
                }, 3000);
            }

            // Toggle loading state
            toggleLoading(show) {
                const loader = document.getElementById('loading');
                if (show) {
                    loader.classList.add('active');
                } else {
                    loader.classList.remove('active');
                }
            }
        }

        // Initialize the application
        let jacketCustomizer;
        document.addEventListener('DOMContentLoaded', () => {
            jacketCustomizer = new JacketCustomizer();
        });

        // Global functions for HTML onclick handlers
        function switchSection(section) {
            jacketCustomizer.switchSection(section);
        }

        function openCropModal() {
            jacketCustomizer.openCropModal();
        }

        function closeCropModal() {
            jacketCustomizer.closeCropModal();
        }

        function cropAndAddPatch() {
            jacketCustomizer.cropAndAddPatch();
        }

        function clearPatches() {
            jacketCustomizer.clearPatches();
        }

        function saveDesign() {
            jacketCustomizer.saveDesign();
        }

        function exportDesign() {
            jacketCustomizer.exportDesign();
        }

        function addTextToJacket() {
            jacketCustomizer.addTextToJacket();
        }

        function selectFont(element, font, fontClass) {
            jacketCustomizer.selectFont(element, font, fontClass);
        }

        function selectJacket(color) {
            jacketCustomizer.selectJacket(color);
        }

        function toggleMobileMenu() {
            const menu = document.getElementById('mobileMenu');
            menu.classList.toggle('hidden');
        }

        function shareToWhatsApp() {
            const text = "Check out this free senior jacket designer! Create your custom jacket design! ";
            const url = window.location.href;
            window.open(`https://wa.me/?text=${encodeURIComponent(text + url)}`);
        }

        function shareLink() {
            navigator.clipboard.writeText(window.location.href);
            alert('Link copied to clipboard! Share it with your friends!');
        }
    </script>
</body>
</html>
